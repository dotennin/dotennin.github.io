Rmodules&&"function"==typeof Rmodules.define&&Rmodules.define(["jQuery","R^1","R.api=1.4.2"],function(e,t){"use strict";var s,a={NOT_LOGGED:1,NONE:2,NORMAL:3,ERROR:4,SUPER_DEAL:5,DISABLED:6},i={config:{settingsContainer:".spux-settings",settingsGlobal:".spux-settings-global",settingsCss:".spux-settings-css",settingsSpu:".spux-settings-spu",templateIconData:".spux-template-icon-data",templatePointData:".spux-template-point-data",templatePopupData:".spux-template-popup-data"},global:{enabled:[!0,"bool"],waitDom:[!1,"bool"],useTemplate:[void 0,"enumValue",a],sectionNameMaxLength:[64,"int"],serviceNameMaxLength:[64,"int"],disabledSections:["","str"],disabledServices:["","str"],orderSections:["","str"],orderServices:["","str"],userLogged:[void 0,"bool"],showEmptySections:[!1,"bool"],showEmptyServices:[!1,"bool"],componentData:["spux","str"],componentEvent:["spux-data-ready","str"],globalReplacement:["{{%}}","str"],deal:[!1,"bool"]},css:{sEventElem:[".spux-icon-container,.spux-popup-container","str"],sIcon:[".spux-icon-container","str"],sPoint:[".spux-point-container","str"],sPopup:[".spux-popup-container","str"],sPopupCloseButton:[".spux-popup-close-button","str"],sCase1:[".spux-case-one","str"],sCaseN:[".spux-case-n","str"],sCaseError:[".spux-case-error","str"],sCaseSuperdeal:[".spux-case-superdeal","str"],sCaseNologin:[".spux-case-nologin","str"],sCaseDisabled:[".spux-case-disabled","str"],sTotalRate:[".spux-total-rate","str"],sTotalPoint:[".spux-total-point","str"],cTemplateSection:["spux-section-template","str"],cTemplateService:["spux-service-template","str"],sServiceLink:[".spux-service-link","str"],sSectionToggler:[".spux-section-header .spux-popup-arrow","str"],cTogglerHidden:["toggler-hidden","str"],cReady:["spux-ready","str"],cTotalRate:["spux-totalrate-#TOTAL_RATE#"],cTotalPoint:["spux-totalpoint-#TOTAL_POINT#"],cUserRank:["spux-user-rank-#USER_RANK#","str"],cQualifiesService:["spux-user-qualifies-#SERVICE_ID#","str"],cServiceId:["spux-service-id-#SERVICE_ID#","str"],cServiceQualifies:["spux-service-qualifies","str"],sScaffold:[".spux-scaffold-container","str"],cLoading:["spux-loading","str"],sPrice:[".spux-price","Str"],sPointData:[".spux-point-data","Str"],sPointRate:[".spux-point-rate","Str"],sItemShopRate:[".spux-item-shop-rate","Str"],sDealRate:[".spux-deal-rate","Str"]},spu:{sid:[void 0,"enumValue",t.api.spu.ServiceId],source:[void 0,"enumValue",t.api.spu.Source],viewType:[void 0,"enumValue",t.api.spu.ViewType],userRank:[void 0,"enumValue",t.api.spu.UserRank],itemId:[void 0,"str"],shopId:[void 0,"str"],encoding:[t.api.spu.Encoding.EUC_JP,"enumValue",t.api.spu.Encoding]}},n={},o=0===(s=e(i.config.settingsContainer).last()).length?null:(n.settings=s,{global:t.readSettings(s.find(i.config.settingsGlobal),i.global),css:t.readSettings(s.find(i.config.settingsCss),i.css),spu:t.readApiSettings(s.find(i.config.settingsSpu),i.spu)});function p(s,a){var i,p,l,u,c,d,f,g,m,v,x;if(a){for(d=0,f=(v=o.global.disabledSections.split(",")).length;d<f;d++)v[d]=t.trim(v[d]);for(d=0,f=(x=o.global.disabledServices.split(",")).length;d<f;d++)x[d]=t.trim(x[d]);for(d=0,f=(i=n.templates[s]).length;d<f;d++)if((p=i.eq(d).find("."+o.css.cTemplateSection)).length>0){for(l=p[0].outerHTML,g=0,m=a.sections.length;g<m;g++)c=a.sections[g],-1===v.indexOf(c.id)&&(o.global.showEmptySections||c.services.length>0)&&(u=r(l,c,x),(o.global.showEmptySections||u.nServices>0)&&p.before(u.$section));p.remove()}n.totalRate.html(a.totalRate),n.totalPoint.html(function(t){var s,a=e(o.css.sPrice).attr("price"),i=o.global.deal;if(s=Math.floor(Math.floor(a/100)*t),i){var n=Number(e(".spux-deal-disp-data").attr("point"));s+=n}return String(s).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")}(a.totalRate))}}function r(s,a,i){var n,p,r,u,c,d,f={"#SECTION_ID#":a.id,"#SECTION_NAME#":t.truncate(a.name,o.global.sectionNameMaxLength),"#SECTION_FULLNAME#":a.name,"#SECTION_TOTALRATE#":a.totalRate},g={$section:e(t.applyTemplate(s,f)).removeClass(o.css.cTemplateSection),nServices:0};if((r=g.$section.find("."+o.css.cTemplateService)).length>0){for(u=r[0].outerHTML,c=0,d=a.services.length;c<d;c++)p=a.services[c],-1===i.indexOf(p.id)&&(o.global.showEmptyServices||p.rate>0)&&(n=l(u,p),r.before(n),g.nServices++);r.remove()}return g}function l(s,a){var i,n={"#SERVICE_ID#":a.id,"#SERVICE_NAME#":t.truncate(a.name,o.global.serviceNameMaxLength),"#SERVICE_FULLNAME#":a.name,"#SERVICE_RATE#":a.rate,"#SERVICE_LINK#":a.link};return i=e(t.applyTemplate(s,n)).removeClass(o.css.cTemplateService),a.isQualified&&i.addClass(o.css.cServiceQualifies),a.link||i.find(o.css.sServiceLink).remove(),i}function u(s,i){var r,l,u,c,d,f,g,m,v=n.iconContainer.add(n.pointContainer).add(n.popupContainer),x=o.global.deal;r=s,l=i,u=!1,e.each(e(o.css.sPointData).find(o.css.sPointRate),function(s,i){var n=e(i),o=parseInt(n.attr("rate"),10),p=new t.api.spu.SpuSectionService({});if(p.id=n.attr("id"),p.name=n.attr("name"),p.rate=o,p.isQualified=Boolean(Number(n.attr("qualified"))),p.link=n.attr("link"),e.each(l.sections,function(e,t){a.NORMAL===r&&"itemPoint"===p.id||"bonusPoint"===t.id&&(u=!0,l.totalRate+=parseInt(p.rate),t.totalRate+=parseInt(p.rate),t.services.unshift(p))}),!u){if(a.NORMAL===r&&"itemPoint"===p.id)return;var c=new t.api.spu.SpuSection({services:[p]});c.id="bonusPoint",c.name="キャンペーンポイント内訳",c.totalRate=0,l.totalRate+=parseInt(p.rate),c.totalRate+=parseInt(p.rate),!0===p.isQualified&&(c.services[0].isQualified=!0),l.sections.splice(1,0,c)}return l}),i=l,x&&(c=i,e.each(c.sections,function(t,s){if("spuBasePoint"===s.id||"bonusPoint"===s.id){var a=[];e.each(s.services,function(e,t){"normal"!==t.id&&"itemPoint"!==t.id&&"shopPoint"!==t.id||(c.totalRate-=parseInt(t.rate),s.totalRate-=parseInt(t.rate),a.push(e))}),e.each(a,function(e,t){s.services.splice(t,1)})}}),i=c),function(e){var t,s,i=o.css,p={};p[a.NOT_LOGGED]=i.sCaseNologin,p[a.NONE]=i.sCase1,p[a.NORMAL]=i.sCaseN,p[a.ERROR]=i.sCaseError,p[a.SUPER_DEAL]=i.sCaseSuperdeal,p[a.DISABLED]=i.sCaseDisabled,s="."+p[e].substring(1);for(t in n.templates)n.templates[t].not(s).remove()}(s),function(e){function t(e,t,s){var a=s.indexOf(e.id),i=s.indexOf(t.id);return-1===a&&(a=99999),-1===i&&(i=99999),a-i}function s(e,s){return t(e,s,p)}var a,i,n=o.global.orderSections,p=o.global.orderServices;if(n&&e.sections.sort(function(e,s){return t(e,s,n)}),p)for(a=0,i=e.sections.length;a<i;a++)e.sections[a].services.sort(s)}(i),p(s,i),(i.totalRate>=1&&x||i.totalRate>=2)&&n.icon.children().appendTo(n.iconContainer),n.point.children().appendTo(n.pointContainer),n.popup.children().appendTo(n.popupContainer),i.totalRate>=1&&x&&(d=e(".spux-deal-plus-icon").html(e(".spux-deal-disp-data").attr("plus")),e(".spux-total-rate-display-deal").find(".spux-total-rate").prepend(d),e(".spux-section:first-child .spux-service:first-child .spux-service-rate-plus").addClass("spux-service-rate-plus-deal"),e(".spux-section:first-child .spux-service:first-child .spux-service-rate-plus").removeClass("spux-service-rate-plus")),0!==n.templates.length&&(f=e(".spux-popup"),g=e(".spux-scaffold-container-popup"),m=e(".spux-popup-container"),f.on("click",".spux-open-popup",function(){var t=m.offset();g.addClass("open-popup").show(),e(".spux-popup-container, .spux-popup-bg").show(),m.css("top",t.top+30)}),g.on("click",".spux-popup-bg, .spux-close-popup",function(){g.removeClass("open-popup"),e(".spux-popup-container, .spux-popup-bg").fadeOut(250)})),v.addClass(o.css.cReady),e(o.css.sScaffold).removeClass(o.css.cLoading)}function c(e){var s;return e===a.ERROR?s=JSON.parse('{"totalRate":"1","userRank":1,"sections":[{"id":"spuBasePoint","name":"ポイント内訳","totalRate":"1","services":[{"id":"normal","name":"通常購入分","rate":"1","qualified":true}]}]}'):e!==a.NOT_LOGGED&&e!==a.NONE||(s=JSON.parse('{"totalRate":"1","userRank":1,"sections":[{"id":"spuBasePoint","name":"ポイント内訳","totalRate":"1","services":[{"id":"normal","name":"通常購入分","rate":"1","qualified":true},{"id":"nonlogin","name": "","rate":"1","qualified":true}]}]}')),new t.api.spu.ResponseData(s)}function d(){if(o&&function(){function t(e,t){var s,a;if(e){for(s in t)a=o.global.globalReplacement.replace("%",s.toUpperCase()),e=e.replace(new RegExp(a,"g"),t[s]);return e}}function s(t){var s,a,i;for(a=0,i=t.length;a<i;a++)s=e.extend(s,t.eq(a).data());return s||{}}var p,r,l,u,c=o.css,d={NOT_LOGGED:c.sCaseNologin,NONE:c.sCase1,NORMAL:c.sCaseN,ERROR:c.sCaseError,SUPER_DEAL:c.sCaseSuperdeal,DISABLED:c.sCaseDisabled},f=e(c.sIcon).last(),g=e(c.sPoint).last(),m=e(c.sPopup).last(),v=f.find('script[type="text/template"]'),x=g.find('script[type="text/template"]'),R=m.find('script[type="text/template"]'),S=v.last().html(),E=x.last().html(),h=R.last().html();S=t(S,s(n.settings.find(i.config.templateIconData))),E=t(E,s(n.settings.find(i.config.templatePointData))),h=t(h,s(n.settings.find(i.config.templatePopupData))),p=e("<div>").append(S),r=e("<div>").append(E),l=e("<div>").append(h),v.remove(),x.remove(),R.remove(),n.iconContainer=f,n.pointContainer=g,n.popupContainer=m,n.icon=p,n.point=r,n.popup=l,n.totalRate=p.find(c.sTotalRate).add(l.find(c.sTotalRate)),n.totalPoint=r.find(c.sTotalPoint),n.popupCloseButton=p.find(c.s_popup_close_button).add(l.find(c.sPopupCloseButton)),n.templates={};for(u in d)n.templates[a[u]]=n.icon.find(d[u]).add(n.point.find(d[u])).add(n.popup.find(d[u]));return n.icon.length&&n.iconContainer.length||n.point.length&&n.pointContainer.length||n.popup.length&&n.popupContainer.length}()){if("false"===e("#spu_effective").val())return u(s=a.NONE,c(s)),e(".spux-service-id-nonlogin").html(""),void e(".spux-sections-notice").remove();if(o.global.useTemplate)u(o.global.useTemplate);else if(t.user.isLogged(o.global.userLogged))t.api.spu.loadSpu(e.extend({},o.spu,{encoding:o.spu.encoding,sid:o.spu.sid,source:o.spu.source,viewType:o.spu.viewType,userRank:o.spu.userRank,itemId:o.spu.itemId,shopId:o.spu.shopId})).done(function(e){u(1===e.totalRate?a.NONE:a.NORMAL,e)}).fail(function(){var t=a.ERROR;u(t,c(t)),e(".spux-sections-notice").remove()});else{var s;u(s=a.NOT_LOGGED,c(s)),e(".spux-sections-notice").remove(),e(".spux-service-id-nonlogin").html(e(".spux-link-nonlogin-hide").html())}}}o.global.enabled?o.global.waitDom?e(d):d():e(o.css.sScaffold).removeClass(o.css.cLoading)});